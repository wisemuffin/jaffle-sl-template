name: Production Job DBT via CLI and Datafold (dbt cli runs actual prod job and pull requests)

on:
  push: # Run the job on push to the main branch
    branches:
      - main
      
jobs:
  dbt-build-prod-cli-datafold:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install -r requirements.txt
      - name: Set up Snowflake profile
        env:
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          mkdir -p ~/.dbt/
          echo "snowflake:" >> ~/.dbt/profiles.yml
          echo " target: prod" >> ~/.dbt/profiles.yml
          echo " outputs:" >> ~/.dbt/profiles.yml
          echo "   prod:" >> ~/.dbt/profiles.yml
          echo "     type: snowflake" >> ~/.dbt/profiles.yml
          echo "     account: $SNOWFLAKE_ACCOUNT" >> ~/.dbt/profiles.yml
          echo "     user: $SNOWFLAKE_USER" >> ~/.dbt/profiles.yml
          echo "     password: $SNOWFLAKE_PASSWORD" >> ~/.dbt/profiles.yml
          echo "     role: $SNOWFLAKE_ROLE" >> ~/.dbt/profiles.yml
          echo "     database: $SNOWFLAKE_DATABASE" >> ~/.dbt/profiles.yml
          echo "     warehouse: $SNOWFLAKE_WAREHOUSE" >> ~/.dbt/profiles.yml
          echo "     schema: prod" >> ~/.dbt/profiles.yml
      - name: Install dbt Dependencies
        run: dbt deps
      - name: Generate dbt manifest.json
        run: dbt ls # or dbt compile
      # - name: Instantiate Jaffle Shop data
      #   run: dbt seed
      # - name: dbt Build
      #   run: dbt build
      - name: Install Datafold SDK
        run: pip install -q datafold-sdk
      - name: Upload dbt artifacts to Datafold
        run: datafold dbt upload --ci-config-id 305 --run-type production --commit-sha ${GIT_SHA}
        env:
          DATAFOLD_API_KEY: ${{ secrets.DATAFOLD_API_KEY }}
          GIT_SHA: "${{ github.sha }}"


      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          # role-external-id: ${{ secrets.AWS_ROLE_EXTERNAL_ID }}
          role-duration-seconds: 1200
          role-session-name: MySessionName
          
      - name: Upload manifest.json from s3 for cli based slim ci
        run: |
          aws s3 cp ./target/manifest.json s3://jaffle-sl-template/prod/manifest/manifest.json
  
      # - name: Generate Docs
      #   run: dbt docs generate --no-version-check --profiles-dir ./ci_profiles
      
      # - name: Publish Docs
      #   run: |
      #     aws s3 cp ./target/index.html s3://jaffle-sl-template/
      #     aws s3 cp ./target/catalog.json s3://jaffle-sl-template/
      #     aws s3 cp ./target/manifest.json s3://jaffle-sl-template/
